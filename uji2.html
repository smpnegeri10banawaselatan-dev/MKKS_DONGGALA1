<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard MKKS ROSO NU SINTUVU</title>

  <!-- Tailwind & Bootstrap -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- FileSaver & XLSX for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #e0f2fe, #f8fafc);
      font-family: 'Inter', sans-serif;
    }
    .card-hover:hover {
      transform: scale(1.02);
      transition: 0.3s;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-blue-700 text-white shadow-md py-4 px-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold">ðŸ“Š Dashboard MKKS ROSO NU SINTUVU</h1>
    <div id="currentDateTime" class="text-sm"></div>
  </header>

  <!-- Statistik -->
  <section class="p-6 grid grid-cols-1 md:grid-cols-4 gap-4">
    <div class="bg-white shadow-md rounded-xl p-4 flex items-center justify-between card-hover">
      <div>
        <p class="text-gray-500 text-sm">Total Sekolah</p>
        <h3 id="totalSekolah" class="text-2xl font-bold text-blue-600">0</h3>
      </div>
      <i class="fas fa-school text-blue-500 text-3xl"></i>
    </div>
    <div class="bg-white shadow-md rounded-xl p-4 flex items-center justify-between card-hover">
      <div>
        <p class="text-gray-500 text-sm">Punya Website</p>
        <h3 id="totalWebsite" class="text-2xl font-bold text-green-600">0</h3>
      </div>
      <i class="fas fa-globe text-green-500 text-3xl"></i>
    </div>
    <div class="bg-white shadow-md rounded-xl p-4 flex items-center justify-between card-hover">
      <div>
        <p class="text-gray-500 text-sm">Punya Foto</p>
        <h3 id="totalFoto" class="text-2xl font-bold text-yellow-600">0</h3>
      </div>
      <i class="fas fa-image text-yellow-500 text-3xl"></i>
    </div>
    <div class="bg-white shadow-md rounded-xl p-4 flex items-center justify-between card-hover">
      <div>
        <p class="text-gray-500 text-sm">Data Lengkap</p>
        <h3 id="totalLengkap" class="text-2xl font-bold text-purple-600">0</h3>
      </div>
      <i class="fas fa-check-circle text-purple-500 text-3xl"></i>
    </div>
  </section>

  <!-- Filter dan Ekspor -->
  <section class="px-6 mb-4 flex flex-wrap gap-2 justify-between items-center">
    <div class="flex items-center gap-2">
      <input id="searchInput" type="text" placeholder="Cari sekolah..." class="border border-gray-300 rounded-lg px-3 py-2 focus:ring focus:ring-blue-200" />
      <select id="filterWebsite" class="border border-gray-300 rounded-lg px-3 py-2">
        <option value="">Semua</option>
        <option value="Punya Website">Punya Website</option>
        <option value="Tidak Punya Website">Tidak Punya Website</option>
      </select>
      <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"><i class="fas fa-sync-alt mr-1"></i> Refresh</button>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"><i class="fas fa-file-excel mr-1"></i> Excel</button>
      <button onclick="exportToPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"><i class="fas fa-file-pdf mr-1"></i> PDF</button>
      <label for="itemsPerPage" class="text-sm text-gray-600">Tampil:</label>
      <select id="itemsPerPage" class="border border-gray-300 rounded-lg px-2 py-1 text-sm">
        <option>6</option>
        <option>12</option>
        <option>24</option>
      </select>
    </div>
  </section>

  <!-- Kontainer Sekolah -->
  <section class="px-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="schoolContainer"></section>

  <!-- Pagination -->
  <div class="flex justify-center my-4" id="pagination"></div>

  <!-- Footer -->
  <footer class="bg-blue-800 text-white text-center py-3 mt-auto">
    &copy; 2025 MKKS ROSO NU SINTUVU â€” Semua Hak Dilindungi
  </footer>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/1rgI2BHnTH20CGvGcLwTHIsWM-q9Nc1cPxdxtYWrln98/gviz/tq?tqx=out:json&sheet=sekolah";

    let schoolData = [];
    let currentPage = 1;
    let itemsPerPage = 6;

    async function fetchSchoolData() {
      document.getElementById("schoolContainer").innerHTML = "<p class='text-center text-gray-500 w-full'>Memuat data...</p>";
      try {
        const res = await fetch(sheetURL);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;

        schoolData = rows.map(r => ({
          nama: r.c[0]?.v || "-",
          kepala: r.c[1]?.v || "-",
          nip: r.c[2]?.v || "-",
          website: r.c[3]?.v || "",
          foto1: r.c[4]?.v || "",
          foto2: r.c[5]?.v || "",
          foto3: r.c[6]?.v || ""
        }));

        updateStats();
        renderSchools();
      } catch (err) {
        document.getElementById("schoolContainer").innerHTML = "<p class='text-center text-red-500'>Gagal memuat data!</p>";
        console.error(err);
      }
    }

    function updateStats() {
      const total = schoolData.length;
      const punyaWebsite = schoolData.filter(s => s.website).length;
      const punyaFoto = schoolData.filter(s => s.foto1 || s.foto2 || s.foto3).length;
      const lengkap = schoolData.filter(s => s.website && s.kepala !== "-" && (s.foto1 || s.foto2)).length;

      document.getElementById("totalSekolah").textContent = total;
      document.getElementById("totalWebsite").textContent = punyaWebsite;
      document.getElementById("totalFoto").textContent = punyaFoto;
      document.getElementById("totalLengkap").textContent = lengkap;
    }

    function filterSchools() {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      const filterWeb = document.getElementById("filterWebsite").value;

      let filtered = schoolData.filter(s => s.nama.toLowerCase().includes(keyword));

      if (filterWeb === "Punya Website") filtered = filtered.filter(s => s.website);
      if (filterWeb === "Tidak Punya Website") filtered = filtered.filter(s => !s.website);

      renderSchools(filtered);
    }

    function renderSchools(data = schoolData) {
      const container = document.getElementById("schoolContainer");
      container.innerHTML = "";

      const start = (currentPage - 1) * itemsPerPage;
      const paginated = data.slice(start, start + itemsPerPage);

      paginated.forEach(s => {
        const photos = [s.foto1, s.foto2, s.foto3].filter(f => f);
        const hasPhotos = photos.length > 0;
        const card = document.createElement("div");
        card.className = "bg-white shadow-md rounded-xl p-4 card-hover";

        card.innerHTML = `
          <h4 class="font-semibold text-lg mb-2 text-blue-700">${s.nama}</h4>
          <p class="text-sm text-gray-600 mb-1"><b>Kepala:</b> ${s.kepala}</p>
          <p class="text-sm text-gray-600 mb-2"><b>NIP:</b> ${s.nip}</p>
          ${s.website ? `<a href="${s.website}" target="_blank" class="text-blue-600 hover:underline text-sm"><i class="fas fa-globe"></i> Website</a>` : `<span class="text-gray-400 text-sm"><i class="fas fa-globe"></i> Tidak ada website</span>`}
          <div class="mt-3">
            ${hasPhotos ? `
              <div id="carousel-${s.nama.replace(/\s+/g, '')}" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                  ${photos.map((url, i) => `
                    <div class="carousel-item ${i === 0 ? 'active' : ''}">
                      <img src="${url}" class="d-block w-100 rounded-lg" alt="Foto ${s.nama}">
                    </div>`).join('')}
                </div>
              </div>` : `<div class="text-gray-400 text-sm text-center py-4">Tidak ada foto</div>`}
          </div>
        `;
        container.appendChild(card);
        if (hasPhotos) startAutoSlideshow(`carousel-${s.nama.replace(/\s+/g, '')}`);
      });

      renderPagination(data.length);
    }

    function renderPagination(totalItems) {
      const pagination = document.getElementById("pagination");
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      pagination.innerHTML = "";

      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = `mx-1 px-3 py-1 rounded-lg ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-white border'}`;
        btn.onclick = () => { currentPage = i; renderSchools(); };
        pagination.appendChild(btn);
      }
    }

    function startAutoSlideshow(id) {
      const carousel = document.getElementById(id);
      const slides = carousel.querySelectorAll('.carousel-item');
      let index = 0;
      setInterval(() => {
        slides[index].classList.remove('active');
        index = (index + 1) % slides.length;
        slides[index].classList.add('active');
      }, 4000);
    }

    function refreshData() {
      fetchSchoolData();
    }

    // Ekspor Excel
    function exportToExcel() {
      const ws = XLSX.utils.json_to_sheet(schoolData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Data Sekolah");
      XLSX.writeFile(wb, "Data_Sekolah_MKKS.xlsx");
    }

    // Ekspor PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text("Laporan Data Sekolah MKKS ROSO NU SINTUVU", 10, 10);
      let y = 20;
      schoolData.forEach((s, i) => {
        doc.text(`${i + 1}. ${s.nama} - ${s.kepala}`, 10, y);
        y += 8;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save("Data_Sekolah_MKKS.pdf");
    }

    function updateDateTime() {
      const now = new Date();
      document.getElementById("currentDateTime").textContent = now.toLocaleString('id-ID', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }

    document.getElementById("searchInput").addEventListener("input", filterSchools);
    document.getElementById("filterWebsite").addEventListener("change", filterSchools);
    document.getElementById("itemsPerPage").addEventListener("change", e => {
      itemsPerPage = parseInt(e.target.value);
      currentPage = 1;
      renderSchools();
    });

    window.onload = () => {
      fetchSchoolData();
      setInterval(updateDateTime, 1000);
    };
  </script>
</body>
</html>
